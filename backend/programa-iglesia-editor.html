<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Editor de Programa Â· Church Manager</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --navy:       #1B2D5B;
    --navy-mid:   #2A4080;
    --navy-light: #3B5BA8;
    --gold:       #C8A84B;
    --gold-light: #E8C96A;
    --gold-pale:  #FBF4E2;
    --gray-900:   #111827;
    --gray-700:   #374151;
    --gray-500:   #6B7280;
    --gray-300:   #D1D5DB;
    --gray-100:   #F3F4F6;
    --bg:         #F7F8FC;
    --white:      #FFFFFF;
    --red:        #EF4444;
    --green:      #22C55E;
    --shadow-sm:  0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md:  0 4px 16px rgba(0,0,0,0.10), 0 2px 6px rgba(0,0,0,0.06);
    --shadow-lg:  0 10px 40px rgba(0,0,0,0.14);
    --r:          12px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--gray-900);
    min-height: 100vh;
  }

  /* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .topbar {
    background: var(--navy);
    padding: 0 2rem;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  }
  .topbar-brand {
    display: flex;
    align-items: center;
    gap: 10px;
    color: white;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: 0.03em;
  }
  .topbar-brand span {
    color: var(--gold-light);
  }
  .topbar-badge {
    background: rgba(200,168,75,0.18);
    color: var(--gold-light);
    border: 1px solid rgba(200,168,75,0.3);
    font-size: 0.7rem;
    font-weight: 600;
    padding: 2px 10px;
    border-radius: 20px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .workspace {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 0;
    max-width: 1280px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    gap: 2rem;
    align-items: start;
  }

  /* â”€â”€ PANEL IZQUIERDO: EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .panel {
    background: var(--white);
    border-radius: var(--r);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    position: sticky;
    top: 72px;
  }
  .panel-header {
    background: var(--navy);
    padding: 1.25rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .panel-header h2 {
    color: white;
    font-size: 0.95rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .panel-body { padding: 1.5rem; }

  .form-group { margin-bottom: 1rem; }
  .form-group label {
    display: block;
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--gray-500);
    margin-bottom: 5px;
  }
  .form-group input,
  .form-group select {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--gray-300);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem;
    color: var(--gray-900);
    background: var(--white);
    transition: border-color 0.15s, box-shadow 0.15s;
    outline: none;
  }
  .form-group input:focus,
  .form-group select:focus {
    border-color: var(--navy-light);
    box-shadow: 0 0 0 3px rgba(59,91,168,0.12);
  }
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }

  /* SecciÃ³n de personas */
  .section-title {
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--gray-500);
    margin: 1.25rem 0 0.75rem;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--gray-100);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .btn-randomize {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    background: var(--gold-pale);
    color: var(--navy);
    border: 1px solid var(--gold);
    border-radius: 6px;
    font-size: 0.72rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
    text-transform: none;
    letter-spacing: 0;
  }
  .btn-randomize:hover {
    background: var(--gold);
    color: var(--navy);
  }

  /* Filas de asignaciÃ³n */
  .assignment-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid var(--gray-100);
    animation: slideIn 0.2s ease;
  }
  .assignment-row:last-child { border-bottom: none; }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-4px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .role-badge {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    background: var(--navy);
    color: var(--gold-light);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 700;
  }
  .role-label {
    flex-shrink: 0;
    width: 110px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--navy);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .name-input {
    flex: 1;
    padding: 6px 10px;
    border: 1.5px solid var(--gray-300);
    border-radius: 7px;
    font-size: 0.83rem;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: all 0.15s;
    color: var(--gray-900);
    min-width: 0;
  }
  .name-input:focus {
    border-color: var(--navy-light);
    box-shadow: 0 0 0 3px rgba(59,91,168,0.1);
  }
  .name-input.assigned {
    background: #f0f4ff;
    border-color: rgba(27,45,91,0.25);
  }
  .btn-clear {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    background: none;
    border: 1.5px solid var(--gray-300);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-500);
    transition: all 0.15s;
    font-size: 0.85rem;
  }
  .btn-clear:hover {
    background: #FEE2E2;
    border-color: var(--red);
    color: var(--red);
  }

  /* â”€â”€ BOTONES DE ACCIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .actions {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }
  .btn {
    width: 100%;
    padding: 11px 16px;
    border-radius: 9px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.18s;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
  }
  .btn-primary {
    background: var(--navy);
    color: white;
  }
  .btn-primary:hover {
    background: var(--navy-mid);
    transform: translateY(-1px);
    box-shadow: 0 4px 14px rgba(27,45,91,0.3);
  }
  .btn-gold {
    background: var(--gold);
    color: var(--navy);
  }
  .btn-gold:hover {
    background: var(--gold-light);
    transform: translateY(-1px);
    box-shadow: 0 4px 14px rgba(200,168,75,0.35);
  }
  .btn-outline {
    background: transparent;
    color: var(--navy);
    border: 1.5px solid var(--gray-300);
  }
  .btn-outline:hover {
    border-color: var(--navy);
    background: var(--gray-100);
  }

  /* â”€â”€ PANEL DERECHO: VISTA PREVIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .preview-wrapper {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .preview-label {
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--gray-500);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .preview-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--gray-300);
  }
  .preview-live-badge {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.68rem;
    color: var(--green);
    font-weight: 600;
  }
  .live-dot {
    width: 6px;
    height: 6px;
    background: var(--green);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50%       { opacity: 0.5; transform: scale(1.3); }
  }

  /* â”€â”€ FLYER PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .flyer-container {
    background: var(--white);
    border-radius: var(--r);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    width: 100%;
    max-width: 540px;
    margin: 0 auto;
    position: relative;
  }

  /* HEADER DEL FLYER */
  .flyer-header {
    background: linear-gradient(135deg, #1B2D5B 0%, #2A4080 60%, #1B2D5B 100%);
    padding: 1.8rem 2rem 1.5rem;
    position: relative;
    overflow: hidden;
  }
  .flyer-header::before {
    content: '';
    position: absolute;
    top: -40px; right: -40px;
    width: 160px; height: 160px;
    background: rgba(200,168,75,0.08);
    border-radius: 50%;
  }
  .flyer-header::after {
    content: '';
    position: absolute;
    bottom: -20px; left: -30px;
    width: 120px; height: 120px;
    background: rgba(200,168,75,0.05);
    border-radius: 50%;
  }
  .header-inner {
    display: flex;
    align-items: center;
    gap: 1.1rem;
    position: relative;
    z-index: 1;
  }
  .logo-circle {
    width: 60px;
    height: 60px;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(200,168,75,0.5);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.6rem;
    flex-shrink: 0;
    backdrop-filter: blur(4px);
  }
  .logo-img {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    object-fit: contain;
    border: 2px solid rgba(200,168,75,0.4);
  }
  .header-text { flex: 1; }
  .flyer-church-name {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.35rem;
    font-weight: 700;
    color: white;
    line-height: 1.1;
    letter-spacing: 0.02em;
  }
  .flyer-church-sub {
    font-size: 0.75rem;
    color: var(--gold-light);
    margin-top: 2px;
    letter-spacing: 0.05em;
  }
  .flyer-church-loc {
    font-size: 0.68rem;
    color: rgba(255,255,255,0.5);
    margin-top: 3px;
  }

  /* Banda dorada */
  .gold-band {
    height: 4px;
    background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold) 100%);
  }

  /* BADGE CULTO */
  .flyer-badge-row {
    display: flex;
    justify-content: center;
    padding: 1.1rem 2rem 0.4rem;
  }
  .flyer-badge {
    background: var(--gold);
    color: var(--navy);
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.1rem;
    font-weight: 700;
    padding: 6px 24px;
    border-radius: 30px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  /* Fecha y hora */
  .flyer-date-row {
    text-align: center;
    padding: 0.4rem 2rem 0.2rem;
  }
  .flyer-date {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.05rem;
    color: var(--navy);
    font-weight: 600;
  }
  .flyer-time {
    font-size: 0.8rem;
    color: var(--gray-500);
    margin-top: 2px;
  }

  /* Separador ornamental */
  .ornament {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0.5rem 2rem;
  }
  .ornament-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--gray-300), transparent);
  }
  .ornament-diamonds {
    display: flex;
    gap: 4px;
  }
  .ornament-diamonds span {
    display: block;
    width: 5px;
    height: 5px;
    background: var(--gold);
    transform: rotate(45deg);
    opacity: 0.7;
  }
  .ornament-diamonds span:nth-child(2) { opacity: 1; }

  /* SECCIÃ“N TÃTULO */
  .flyer-section-title {
    text-align: center;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--navy);
    padding-bottom: 0.5rem;
  }

  /* TABLA DE PROGRAMA */
  .flyer-table {
    padding: 0 1.5rem 1rem;
  }
  .flyer-row {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    border-radius: 8px;
    margin-bottom: 4px;
    min-height: 44px;
    transition: background 0.15s;
  }
  .flyer-row:nth-child(odd) { background: var(--gray-100); }
  .flyer-row:nth-child(even) { background: var(--white); border: 1px solid var(--gray-100); }
  .flyer-row-num {
    flex-shrink: 0;
    width: 22px;
    height: 22px;
    background: var(--navy);
    color: var(--gold-light);
    border-radius: 5px;
    font-size: 0.65rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
  }
  .flyer-row-role {
    flex-shrink: 0;
    width: 140px;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--navy);
  }
  .flyer-row-person {
    flex: 1;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-900);
    font-style: italic;
  }
  .flyer-row-person.empty {
    color: var(--gray-300);
    font-style: normal;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.78rem;
    font-weight: 400;
    letter-spacing: 0.03em;
  }

  /* VERSÃCULO */
  .flyer-verse {
    text-align: center;
    padding: 0.8rem 2rem 0.5rem;
    border-top: 1px solid var(--gray-100);
    margin: 0 1.5rem;
  }
  .flyer-verse p {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.88rem;
    font-style: italic;
    color: var(--gray-500);
    line-height: 1.5;
  }
  .flyer-verse cite {
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--gold);
    font-style: normal;
    letter-spacing: 0.05em;
    display: block;
    margin-top: 3px;
  }

  /* FOOTER FLYER */
  .flyer-footer {
    background: var(--navy);
    padding: 10px 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 0.8rem;
  }
  .flyer-footer-text {
    font-size: 0.72rem;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--navy);
    color: white;
    padding: 12px 18px;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 8px;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    pointer-events: none;
  }
  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }
  .toast.success { border-left: 4px solid var(--green); }
  .toast.gold    { border-left: 4px solid var(--gold); }

  /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 900px) {
    .workspace {
      grid-template-columns: 1fr;
      padding: 1rem;
    }
    .panel { position: static; }
  }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-brand">
    âœ Church<span>Manager</span>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <div class="preview-live-badge">
      <div class="live-dot"></div>
      Vista en tiempo real
    </div>
    <span class="topbar-badge">Editor de Programa</span>
  </div>
</div>

<!-- WORKSPACE -->
<div class="workspace">

  <!-- â”€â”€ PANEL IZQUIERDO: CONTROLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel">
    <div class="panel-header">
      <h2>âš™ï¸ ConfiguraciÃ³n</h2>
    </div>
    <div class="panel-body">

      <!-- Iglesia -->
      <div class="form-group">
        <label>Nombre de la iglesia</label>
        <input type="text" id="churchName" value="IGLESIA ARCA EVANGÃ‰LICA" oninput="update()"/>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>SubtÃ­tulo</label>
          <input type="text" id="churchSub" value="Dios Fuerte" oninput="update()"/>
        </div>
        <div class="form-group">
          <label>Tipo de culto</label>
          <input type="text" id="worshipType" value="Culto de JÃ³venes" oninput="update()"/>
        </div>
      </div>
      <div class="form-group">
        <label>UbicaciÃ³n</label>
        <input type="text" id="location" value="Santo Domingo Oeste, RepÃºblica Dominicana" oninput="update()"/>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Fecha</label>
          <input type="date" id="dateInput" oninput="update()"/>
        </div>
        <div class="form-group">
          <label>Hora</label>
          <input type="time" id="timeInput" value="19:00" oninput="update()"/>
        </div>
      </div>

      <!-- VersÃ­culo -->
      <div class="form-group">
        <label>VersÃ­culo (footer)</label>
        <input type="text" id="verse" value="Mateo 28:19" oninput="update()"/>
      </div>

      <!-- Secciones / Personas -->
      <div class="section-title">
        Asignaciones del programa
        <button class="btn-randomize" onclick="randomizeAll()">
          ğŸ² Asignar al azar
        </button>
      </div>

      <div id="assignmentsList"></div>

      <!-- Acciones -->
      <div class="actions">
        <button class="btn btn-gold" onclick="exportPDF()">
          â¬‡ï¸ Descargar PDF
        </button>
        <button class="btn btn-outline" onclick="randomizeAll()">
          ğŸ”€ Reasignar personas
        </button>
        <button class="btn btn-outline" onclick="clearAll()">
          ğŸ—‘ï¸ Limpiar todas las asignaciones
        </button>
      </div>

    </div>
  </div>

  <!-- â”€â”€ PANEL DERECHO: PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="preview-wrapper">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <span class="preview-label">Vista previa del flyer</span>
      <div class="preview-live-badge">
        <div class="live-dot"></div>
        Se actualiza en tiempo real
      </div>
    </div>

    <div class="flyer-container" id="flyerPreview">

      <!-- Header -->
      <div class="flyer-header">
        <div class="header-inner">
          <div class="logo-circle" id="logoCircle">âœ</div>
          <div class="header-text">
            <div class="flyer-church-name" id="prevChurchName">IGLESIA ARCA EVANGÃ‰LICA</div>
            <div class="flyer-church-sub" id="prevChurchSub">Dios Fuerte</div>
            <div class="flyer-church-loc" id="prevLocation">Santo Domingo Oeste, RepÃºblica Dominicana</div>
          </div>
        </div>
      </div>

      <div class="gold-band"></div>

      <!-- Badge -->
      <div class="flyer-badge-row">
        <div class="flyer-badge" id="prevWorshipType">Culto de JÃ³venes</div>
      </div>

      <!-- Fecha y hora -->
      <div class="flyer-date-row">
        <div class="flyer-date" id="prevDate">â€”</div>
        <div class="flyer-time" id="prevTime">7:00 PM</div>
      </div>

      <!-- Separador ornamental -->
      <div class="ornament">
        <div class="ornament-line"></div>
        <div class="ornament-diamonds">
          <span></span><span></span><span></span>
        </div>
        <div class="ornament-line"></div>
      </div>

      <div class="flyer-section-title">Orden del Culto</div>

      <!-- Tabla de programa -->
      <div class="flyer-table" id="prevTable"></div>

      <!-- VersÃ­culo -->
      <div class="flyer-verse">
        <p>"Por tanto, id, y haced discÃ­pulos a todas las naciones"</p>
        <cite id="prevVerse">Mateo 28:19</cite>
      </div>

      <!-- Footer -->
      <div class="flyer-footer">
        <span class="flyer-footer-text" id="prevFooter">IGLESIA ARCA EVANGÃ‰LICA</span>
      </div>

    </div>
  </div>

</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATOS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ROLES = [
  { id: 1, name: "DirecciÃ³n" },
  { id: 2, name: "AdoraciÃ³n" },
  { id: 3, name: "Devocional" },
  { id: 4, name: "Coro de Ofrendas" },
  { id: 5, name: "Mensaje" },
];


let PEOPLE_POOL = [];

async function loadPeoplePool() {
  try {
    // Ajusta la URL si tu API es diferente o requiere autenticaciÃ³n
    const res = await fetch('/api/v1/persons?status=active');
    const data = await res.json();
    if (data.success && Array.isArray(data.data)) {
      PEOPLE_POOL = data.data.map(p => p.fullName);
      randomizeAll(); // Asignar personas al cargar
    } else {
      PEOPLE_POOL = [];
      showToast("No se encontraron personas activas", "error");
    }
  } catch (e) {
    PEOPLE_POOL = [];
    showToast("Error cargando personas activas", "error");
  }
}

// Estado reactivo
const state = {
  assignments: ROLES.map(r => ({ ...r, person: "" })),
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("DOMContentLoaded", () => {
  // Fecha por defecto: hoy
  const today = new Date();
  document.getElementById("dateInput").value = today.toISOString().split("T")[0];

  renderEditor();
  loadPeoplePool(); // Cargar personas activas y asignar al azar
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER EDITOR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEditor() {
  const container = document.getElementById("assignmentsList");
  container.innerHTML = "";

  state.assignments.forEach((a, i) => {
    const row = document.createElement("div");
    row.className = "assignment-row";
    row.innerHTML = `
      <div class="role-badge">${String(a.id).padStart(2,"0")}</div>
      <div class="role-label" title="${a.name}">${a.name}</div>
      <input
        type="text"
        class="name-input${a.person ? " assigned" : ""}"
        placeholder="Sin asignar"
        value="${a.person}"
        oninput="updatePerson(${i}, this.value)"
        data-idx="${i}"
      />
      <button class="btn-clear" title="Limpiar" onclick="clearPerson(${i})">âœ•</button>
    `;
    container.appendChild(row);
  });

  updatePreview();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ESTADO â†’ PREVIEW (tiempo real)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePreview() {
  // Datos de texto simples
  document.getElementById("prevChurchName").textContent =
    document.getElementById("churchName").value || "Iglesia";
  document.getElementById("prevChurchSub").textContent =
    document.getElementById("churchSub").value;
  document.getElementById("prevLocation").textContent =
    document.getElementById("location").value;
  document.getElementById("prevWorshipType").textContent =
    document.getElementById("worshipType").value || "Culto";
  document.getElementById("prevVerse").textContent =
    document.getElementById("verse").value;
  document.getElementById("prevFooter").textContent =
    (document.getElementById("churchName").value || "Iglesia").toUpperCase();

  // Fecha
  const dateVal = document.getElementById("dateInput").value;
  if (dateVal) {
    const d = new Date(dateVal + "T12:00:00");
    const opts = { weekday:"long", day:"numeric", month:"long", year:"numeric" };
    const formatted = d.toLocaleDateString("es-DO", opts);
    document.getElementById("prevDate").textContent =
      formatted.charAt(0).toUpperCase() + formatted.slice(1);
  }

  // Hora
  const timeVal = document.getElementById("timeInput").value;
  if (timeVal) {
    const [h, m] = timeVal.split(":");
    const hour = parseInt(h);
    const ampm = hour >= 12 ? "PM" : "AM";
    const hour12 = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
    document.getElementById("prevTime").textContent = `${hour12}:${m} ${ampm}`;
  }

  // Tabla de programa
  const table = document.getElementById("prevTable");
  table.innerHTML = state.assignments.map((a, i) => `
    <div class="flyer-row">
      <div class="flyer-row-num">${String(a.id).padStart(2,"0")}</div>
      <div class="flyer-row-role">${a.name}</div>
      <div class="flyer-row-person${a.person ? "" : " empty"}">
        ${a.person || "â€” â€” â€” â€” â€” â€” â€”"}
      </div>
    </div>
  `).join("");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACCIONES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function update() { updatePreview(); }

function updatePerson(idx, value) {
  state.assignments[idx].person = value;
  // Actualizar clase del input
  const inputs = document.querySelectorAll(".name-input");
  inputs[idx].classList.toggle("assigned", !!value);
  updatePreview();
}

function clearPerson(idx) {
  state.assignments[idx].person = "";
  const inputs = document.querySelectorAll(".name-input");
  inputs[idx].value = "";
  inputs[idx].classList.remove("assigned");
  updatePreview();
  showToast("ğŸ—‘ï¸ AsignaciÃ³n eliminada", "success");
}

function clearAll() {
  state.assignments.forEach(a => a.person = "");
  renderEditor();
  showToast("ğŸ—‘ï¸ Todas las asignaciones borradas", "success");
}

function randomizeAll() {
  const shuffled = [...PEOPLE_POOL].sort(() => Math.random() - 0.5);
  state.assignments.forEach((a, i) => {
    a.person = shuffled[i % shuffled.length];
  });
  renderEditor();
  showToast("ğŸ² Personas asignadas al azar", "gold");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXPORTAR PDF con jsPDF (renderizado del flyer)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportPDF() {
  showToast("â³ Generando PDF...", "gold");

  const { jsPDF } = window.jspdf;

  // Dimensiones A4
  const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  const PW = 210, PH = 297;
  const M = 14;
  const CW = PW - M * 2;

  // â”€â”€ Colores â”€â”€
  const NAVY  = [27, 45, 91];
  const NAVYM = [42, 64, 128];
  const GOLD  = [200, 168, 75];
  const GOLDF = [232, 201, 106];
  const GRAY9 = [17, 24, 39];
  const GRAY5 = [107, 114, 128];
  const GRAY3 = [209, 213, 219];
  const GRAY1 = [243, 244, 246];
  const WHITE = [255, 255, 255];

  // â”€â”€ HELPER â”€â”€
  const setFill = (r,g,b) => doc.setFillColor(r,g,b);
  const setDraw = (r,g,b) => doc.setDrawColor(r,g,b);
  const setTxt  = (r,g,b) => doc.setTextColor(r,g,b);
  const rect    = (x,y,w,h,fill=true) => doc.rect(x,y,w,h, fill ? "F" : "S");
  const rrect   = (x,y,w,h,r,fill=true) => doc.roundedRect(x,y,w,h,r,r, fill ? "F" : "S");

  function centerText(text, y, size, bold=false) {
    doc.setFontSize(size);
    doc.setFont("helvetica", bold ? "bold" : "normal");
    const tw = doc.getTextWidth(text);
    doc.text(text, (PW - tw) / 2, y);
  }

  let y = 0;

  // â”€â”€ 1. HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const HH = 42;
  setFill(...NAVY); rect(0, 0, PW, HH);
  // banda dorada
  setFill(...GOLD); rect(0, HH, PW, 2);

  // Logo placeholder â€” cÃ­rculo con cruz
  setFill(...NAVYM);
  doc.circle(M + 8, HH/2, 8, "F");
  setTxt(...GOLDF);
  doc.setFontSize(14); doc.setFont("helvetica","bold");
  doc.text("+", M + 8 - 2.5, HH/2 + 2.5);

  // Nombre iglesia
  const nx = M + 20;
  setTxt(255,255,255);
  doc.setFontSize(15); doc.setFont("helvetica","bold");
  const cname = document.getElementById("churchName").value.toUpperCase();
  doc.text(cname, nx, HH/2 - 4);

  setTxt(...GOLDF);
  doc.setFontSize(9); doc.setFont("helvetica","normal");
  doc.text(document.getElementById("churchSub").value, nx, HH/2 + 3);

  setTxt(150, 170, 210);
  doc.setFontSize(7.5); doc.setFont("helvetica","normal");
  doc.text(document.getElementById("location").value, nx, HH/2 + 9);

  y = HH + 2;

  // â”€â”€ 2. BADGE TIPO DE CULTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  y += 9;
  const wtype = document.getElementById("worshipType").value.toUpperCase();
  doc.setFontSize(12); doc.setFont("helvetica","bold");
  setTxt(...NAVY);
  const bw = doc.getTextWidth(wtype) + 18;
  const bx = (PW - bw) / 2;
  setFill(...GOLD); rrect(bx, y, bw, 9, 4);
  setTxt(...NAVY);
  doc.setFontSize(9); doc.setFont("helvetica","bold");
  doc.text(wtype, (PW - doc.getTextWidth(wtype)) / 2, y + 6.2);

  // â”€â”€ 3. FECHA Y HORA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  y += 14;
  const dateVal = document.getElementById("dateInput").value;
  let dateStr = "â€”";
  if (dateVal) {
    const d = new Date(dateVal + "T12:00:00");
    const opts = { weekday:"long", day:"numeric", month:"long", year:"numeric" };
    const fmt = d.toLocaleDateString("es-DO", opts);
    dateStr = fmt.charAt(0).toUpperCase() + fmt.slice(1);
  }
  setTxt(...GRAY9);
  doc.setFontSize(11); doc.setFont("helvetica","bold");
  const dw = doc.getTextWidth(dateStr);
  doc.text(dateStr, (PW - dw) / 2, y);

  y += 6;
  const timeVal = document.getElementById("timeInput").value;
  let timeStr = "";
  if (timeVal) {
    const [h, m] = timeVal.split(":");
    const hour = parseInt(h);
    const ampm = hour >= 12 ? "PM" : "AM";
    const h12  = hour > 12 ? hour - 12 : (hour===0 ? 12 : hour);
    timeStr = `${h12}:${m} ${ampm}`;
  }
  setTxt(...GRAY5);
  doc.setFontSize(9); doc.setFont("helvetica","normal");
  const tw2 = doc.getTextWidth(timeStr);
  doc.text(timeStr, (PW - tw2) / 2, y);

  // â”€â”€ 4. SEPARADOR ORNAMENTAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  y += 8;
  setDraw(...GRAY3); doc.setLineWidth(0.4);
  doc.line(M+10, y, PW/2-10, y);
  doc.line(PW/2+10, y, PW-M-10, y);
  // Rombos dorados
  setFill(...GOLD);
  for (let dx of [-5,0,5]) {
    const cx = PW/2 + dx;
    doc.setFillColor(...GOLD);
    doc.rect(cx-1.5, y-1.5, 3, 3, "F");
  }

  // â”€â”€ 5. TÃTULO "ORDEN DEL CULTO" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  y += 9;
  setTxt(...NAVY);
  doc.setFontSize(7.5); doc.setFont("helvetica","bold");
  centerText("ORDEN DEL CULTO", y, 7.5, true);

  // â”€â”€ 6. FILAS DEL PROGRAMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  y += 6;
  const RH = 12.5;

  state.assignments.forEach((a, i) => {
    const rowY = y + i * (RH + 1.5);
    const bg = i % 2 === 0 ? GRAY1 : WHITE;
    setFill(...bg);
    setDraw(...GRAY3);
    doc.setLineWidth(0.3);
    rrect(M, rowY, CW, RH, 3);

    // NÃºmero
    setFill(...NAVY);
    rrect(M + 2, rowY + 2, 7, 8.5, 2);
    setTxt(255,255,255);
    doc.setFontSize(6.5); doc.setFont("helvetica","bold");
    doc.text(String(a.id).padStart(2,"0"), M + 2.8, rowY + 7.8);

    // Rol
    setTxt(...NAVY);
    doc.setFontSize(9); doc.setFont("helvetica","bold");
    doc.text(a.name, M + 12, rowY + 8);

    // Persona o lÃ­nea
    if (a.person) {
      setTxt(...GRAY9);
      doc.setFontSize(9.5); doc.setFont("helvetica","bolditalic");
      doc.text(a.person, M + CW/2 + 2, rowY + 8);
    } else {
      setDraw(192, 199, 212);
      doc.setLineWidth(0.4);
      doc.line(M + CW/2, rowY + 7.5, M + CW - 4, rowY + 7.5);
    }
  });

  y = y + state.assignments.length * (RH + 1.5) + 6;

  // â”€â”€ 7. VERSÃCULO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setDraw(...GRAY3); doc.setLineWidth(0.4);
  doc.line(M+10, y, PW-M-10, y);
  y += 7;
  setTxt(...GRAY5);
  doc.setFontSize(8); doc.setFont("helvetica","italic");
  // Obtener el texto del versÃ­culo y la cita
  let verseInput = document.getElementById("verse").value;
  let verseText = verseInput;
  let verseRef = verseInput;
  // Si el usuario ingresa el texto y la cita separados por un guion, los separamos
  if (verseInput.includes("â€”") || verseInput.includes("-") || verseInput.includes(":")) {
    // Buscar el Ãºltimo guion largo, guion corto o dos puntos para separar texto y cita
    let idx = Math.max(
      verseInput.lastIndexOf("â€”"),
      verseInput.lastIndexOf("-"),
      verseInput.lastIndexOf(":")
    );
    if (idx > 0 && idx < verseInput.length - 1) {
      verseText = verseInput.slice(0, idx).trim();
      verseRef = verseInput.slice(idx + 1).trim();
    }
  }
  // Si el texto estÃ¡ entre comillas, las quitamos para el PDF
  if (verseText.startsWith('"') && verseText.endsWith('"')) {
    verseText = verseText.slice(1, -1);
  }
  // Mostrar el texto del versÃ­culo
  const qtext = verseText || '"Por tanto, id, y haced discÃ­pulos a todas las naciones"';
  const qtw   = doc.getTextWidth(qtext);
  doc.text(qtext, (PW - qtw) / 2, y);

  y += 5.5;
  setTxt(...GOLD);
  doc.setFontSize(7.5); doc.setFont("helvetica","bold");
  const vtw = doc.getTextWidth(verseRef);
  doc.text(verseRef, (PW - vtw) / 2, y);

  // â”€â”€ 8. FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setFill(...NAVY); rect(0, PH - 14, PW, 14);
  setFill(...GOLD); rect(0, PH - 14, PW, 1.5);
  setTxt(255,255,255);
  doc.setFontSize(7.5); doc.setFont("helvetica","bold");
  centerText(cname, PH - 5.5, 7.5, true);

  // â”€â”€ GUARDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const fname = `programa-${document.getElementById("worshipType").value.replace(/\s/g,"-")}-${document.getElementById("dateInput").value || "sin-fecha"}.pdf`;
  doc.save(fname);
  showToast("âœ… PDF descargado exitosamente", "success");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TOAST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg, type="success") {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = `toast ${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.className = "toast", 2800);
}
</script>
</body>
</html>
